unit TestRoomerBookingCommunicationModel_RequestsResponses;
{

  Delphi DUnit Test Case
  ----------------------
  This unit contains a skeleton test case class generated by the Test Case Wizard.
  Modify the generated code to correctly setup and call the methods from the unit 
  being tested.

}

interface

uses
  TestFramework, RoomerFinancialDataModel_ModelObjects, XMLIntf,
  RoomerBookingCommunicationModel_RequestsResponses, uRoomerSchema, Classes,
  SysUtils, OXmlPDOM, Spring.Collections.Lists, Spring.Collections;

type
  // Test methods for class TxsdInvoiceResponse

  TestTxsdInvoiceResponse = class(TTestCase)
  strict private
    FSUT: TxsdInvoiceResponse;
  public
    procedure SetUp; override;
    procedure TearDown; override;
  published
    procedure TestSetuptearDown;
    procedure TestLoadInvoiceResponseXML;
    procedure TestLoadComplexInvoiceResponseXML;
    procedure TestLoadComplexInvoiceResponseWithDiscountsXML;
  end;

implementation

uses
  Math
  , uRoomerCanonicalDataModel_SimpleTypes;

procedure TestTxsdInvoiceResponse.SetUp;
begin
  FSUT := TxsdInvoiceResponse.Create;
end;

procedure TestTxsdInvoiceResponse.TearDown;
begin
  FSUT.Free;
end;

procedure TestTxsdInvoiceResponse.TestLoadComplexInvoiceResponseWithDiscountsXML;
const
  cResponseFile = '..\..\XMLData\InvoiceResponseWithDiscount.xml';
var
  xmlDoc: IXMLDocument;
begin
  xmlDoc := TXMLDocument.Create;
  xmlDoc.LoadFromFile(cResponseFile);

  CheckFalse(Assigned(xmlDoc.ParseError), 'Errors during parsing of XML file');

  FSUT.SetPropertiesFromXMLNode(xmlDoc.DocumentElement.FirstChild);

  CheckEquals(1, FSUT.Count);
  CheckEquals('22822', FSUT.Items[0].RoomReservation);
  CheckEquals(9 , FSUT.Items[0].LineItemList.Count);

  // Check on a discount lineitem
  CheckIs(FSUT.Items[0].LineItemList[7].Item, TxsdDiscountBillableEntryType);
  CheckEquals('GBP', TxsdDiscountBillableEntryType(FSUT.Items[0].LineItemList[7].Item).UnitPrice.Currency.AsString);
  CheckTrue(SameValue(6.98676749, TxsdDiscountBillableEntryType(FSUT.Items[0].LineItemList[7].Item).UnitPrice.Amount));

end;

procedure TestTxsdInvoiceResponse.TestLoadComplexInvoiceResponseXML;
const
  cResponseFile = '..\..\XMLData\InvoiceResponseComplex.xml';
var
  xmlDoc: IXMLDocument;
begin
  xmlDoc := TXMLDocument.Create;
  xmlDoc.LoadFromFile(cResponseFile);

  CheckFalse(Assigned(xmlDoc.ParseError), 'Errors during parsing of XML file');

  FSUT.SetPropertiesFromXMLNode(xmlDoc.DocumentElement.FirstChild);

  CheckEquals(1, FSUT.Count);
  CheckEquals('2589', FSUT.Items[0].Reservation);
  CheckEquals(4 , FSUT.Items[0].LineItemList.Count);

  CheckEquals('Booking Button',  FSUT.Items[0].GuestData.Name);
  CheckEquals('Raupplaan 20',  FSut.items[0].GuestData.Address.Address);
  CheckEquals('NL', FSut.items[0].GuestData.Address.Country.AsString);

  checkEquals('EUR', FSut.items[0].CurrencyData.InvoiceCurrency.AsString);
  checkEquals('EUR', FSut.items[0].CurrencyData.ConversionFromHotelCurrency.From.AsString);
  checkEquals('EUR', FSut.items[0].CurrencyData.ConversionFromHotelCurrency.To_.AsString);
  checkTrue(SameValue(1.0, FSut.items[0].CurrencyData.ConversionFromHotelCurrency.Factor));

end;

procedure TestTxsdInvoiceResponse.TestLoadInvoiceResponseXML;
const
  cResponseFile = '..\..\XMLData\InvoiceResponse.xml';
var
  xmlDoc: IXMLDocument;
const
  cInvoiceResponseFile = '..\..\XMLData\InvoiceResponse.xml';
begin
  xmlDoc := TXMLDocument.Create;
  xmlDoc.LoadFromFile(cInvoiceResponseFile);

  CheckFalse(Assigned(xmlDoc.ParseError), 'Errors during parsing of XML file');

  FSUT.SetPropertiesFromXMLNode(xmlDoc.DocumentElement.FirstChild);

  CheckEquals(1, FSUT.Count);
  CheckEquals('2060', FSUT.Items[0].Reservation);
  CheckEquals(1 , FSUT.Items[0].LineItemList.Count);
  CheckEquals(TxsdExtendedBillableEntryType.Classname , FSUT.Items[0].LineItemList[0].Item.Classname);
  CheckTrue(SameValue(188.6792453 , TxsdExtendedBillableEntryType(FSUT.Items[0].LineItemList[0].Item).TotalPaymentPriceGross.Amount));

  CheckEquals('GUEST-NL' , FSUT.Items[0].CustomerData.Customer);
  CheckEquals('Bjorn Heidarr Gudmundsson' , FSUT.Items[0].GuestData.Name);
  CheckEquals('EUR' , FSUT.Items[0].CurrencyData.InvoiceCurrency.asString);
  CheckEquals('EUR' , FSUT.Items[0].CurrencyData.ConversionFromHotelCurrency.From.AsString);
  CheckEquals('EUR' , FSUT.Items[0].CurrencyData.ConversionFromHotelCurrency.To_.AsString);
  CheckTrue(SameValue(160 , FSUT.Items[0].CurrencyData.ConversionFromHotelCurrency.Factor));



end;

procedure TestTxsdInvoiceResponse.TestSetuptearDown;
begin
  Check(True);
end;

initialization
  // Register any test cases with the test runner
  RegisterTest(TestTxsdInvoiceResponse.Suite);
end.

